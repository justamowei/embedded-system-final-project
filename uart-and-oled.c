/*-----------------------------------------------
  名稱：串口通信
  網站：www.doflye.net
  編寫：shifang
  日期：2009.5
  修改：無
  內容：連接好串口或者usb轉串口至電腦，下載該程序，打開電源
        打開串口調試程序，將波特率設置為9600，無奇偶校驗
        晶振11.0592MHz，發送和接收使用的格式相同，如都使用
        字符型格式，按復位重啟程序，可以看到接收到 UART test，技術論壇：www.doflye.net 請在發送區輸入任意信
        然後在發送區發送任意信息，接收區返回同樣信息，表明串口收發無誤
------------------------------------------------*/

#include <reg52.h>  
#include <string.h>                       
#include <intrins.h>
#include <stdio.h>

#define BUF_SIZE 100
#define KeyPort P2

#define  _Nop()  _nop_()        

#define SSD1306_ADDRESS             0x78
#define SSD1306_LCDWIDTH            128
#define SSD1306_LCDHEIGHT           64
#define SSD1306_SETCONTRAST         0x81
#define SSD1306_DISPLAYALLOW_RESUME 0xA4
#define SSD1306_DISPLAYALLOW        0xA5
#define SSD1306_NORMALDISPLAY       0xA6
#define SSD1306_INVERTDISPLAY       0xA7
#define SSD1306_DISPLAYOFF          0xAE
#define SSD1306_DISPLAYON           0xAF
#define SSD1306_SETDISPLAYOFFSET    0xD3
#define SSD1306_SETCOMPINS          0xDA
#define SSD1306_SETVCOMDETECT       0xDB
#define SSD1306_SETDISPLAYCLOCKDIV  0xD5
#define SSD1306_SETPRECHARGE        0xD9
#define SSD1306_SETMULTIPLEX        0xA8
#define SSD1306_SETLOWCOLUMN        0x00
#define SSD1306_SETHIGHCOLUMN       0x10
#define SSD1306_SETSTARTLINE        0x40
#define SSD1306_MEMORYMODE          0x20
#define SSD1306_COLUMNADDR          0x21
#define SSD1306_PAGEADDR            0x22
#define SSD1306_COMSCANINC          0xC0
#define SSD1306_COMSCANDEC          0xC8
#define SSD1306_SEGREMAP            0xA0
#define SSD1306_CHARGEPUMP          0x8D
#define SSD1306_EXTERNALVCC         0x01
#define SSD1306_SWITCHCAPVCC        0x02

#define OLED_CMD  0	
#define OLED_DATA 1

sbit SDA = P1^0;
sbit SCL = P1^1;

bit ack;	              

xdata char buffer[BUF_SIZE];
xdata char line1[16];  
xdata char line2[16];  
xdata char line3[16];  
xdata char line4[16];
unsigned char index = 0;
bit ready = 0;
bit loading_signal = 0;

xdata char city[20];
xdata char alias[7];
xdata char temp[7];
xdata char utc[7];
xdata char time[22];
xdata char humidity[7];
xdata char weather[10];

code unsigned char F8x16[][16] = {
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //   0
     0x00, 0x00, 0x00, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x30, 0x00, 0x00, 0x00, // ! 1
     0x00, 0x10, 0x0C, 0x06, 0x10, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // " 2
     0x40, 0xC0, 0x78, 0x40, 0xC0, 0x78, 0x40, 0x00, 0x04, 0x3F, 0x04, 0x04, 0x3F, 0x04, 0x04, 0x00, // # 3
     0x00, 0x70, 0x88, 0xFC, 0x08, 0x30, 0x00, 0x00, 0x00, 0x18, 0x20, 0xFF, 0x21, 0x1E, 0x00, 0x00, // $ 4
     0xF0, 0x08, 0xF0, 0x00, 0xE0, 0x18, 0x00, 0x00, 0x00, 0x21, 0x1C, 0x03, 0x1E, 0x21, 0x1E, 0x00, // % 5
     0x00, 0xF0, 0x08, 0x88, 0x70, 0x00, 0x00, 0x00, 0x1E, 0x21, 0x23, 0x24, 0x19, 0x27, 0x21, 0x10, // & 6
     0x10, 0x16, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ' 7
     0x00, 0x00, 0x00, 0xE0, 0x18, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x07, 0x18, 0x20, 0x40, 0x00, // ( 8
     0x00, 0x02, 0x04, 0x18, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x40, 0x20, 0x18, 0x07, 0x00, 0x00, 0x00, // ) 9
     0x40, 0x40, 0x80, 0xF0, 0x80, 0x40, 0x40, 0x00, 0x02, 0x02, 0x01, 0x0F, 0x01, 0x02, 0x02, 0x00, // * 10
     0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x1F, 0x01, 0x01, 0x01, 0x00, // + 11
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xB0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, // , 12
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, // - 13
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, // . 14
     0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x18, 0x04, 0x00, 0x60, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, // / 15
     0x00, 0xE0, 0x10, 0x08, 0x08, 0x10, 0xE0, 0x00, 0x00, 0x0F, 0x10, 0x20, 0x20, 0x10, 0x0F, 0x00, // 0 16
     0x00, 0x10, 0x10, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00, // 1 17
     0x00, 0x70, 0x08, 0x08, 0x08, 0x88, 0x70, 0x00, 0x00, 0x30, 0x28, 0x24, 0x22, 0x21, 0x30, 0x00, // 2 18
     0x00, 0x30, 0x08, 0x88, 0x88, 0x48, 0x30, 0x00, 0x00, 0x18, 0x20, 0x20, 0x20, 0x11, 0x0E, 0x00, // 3 19
     0x00, 0x00, 0xC0, 0x20, 0x10, 0xF8, 0x00, 0x00, 0x00, 0x07, 0x04, 0x24, 0x24, 0x3F, 0x24, 0x00, // 4 20
     0x00, 0xF8, 0x08, 0x88, 0x88, 0x08, 0x08, 0x00, 0x00, 0x19, 0x21, 0x20, 0x20, 0x11, 0x0E, 0x00, // 5 21
     0x00, 0xE0, 0x10, 0x88, 0x88, 0x18, 0x00, 0x00, 0x00, 0x0F, 0x11, 0x20, 0x20, 0x11, 0x0E, 0x00, // 6 22
     0x00, 0x38, 0x08, 0x08, 0xC8, 0x38, 0x08, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00, // 7 23
     0x00, 0x70, 0x88, 0x08, 0x08, 0x88, 0x70, 0x00, 0x00, 0x1C, 0x22, 0x21, 0x21, 0x22, 0x1C, 0x00, // 8 24
     0x00, 0xE0, 0x10, 0x08, 0x08, 0x10, 0xE0, 0x00, 0x00, 0x00, 0x31, 0x22, 0x22, 0x11, 0x0F, 0x00, // 9 25
     0x00, 0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, // : 26
     0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x00, 0x00, 0x00, 0x00, // ; 27
     0x00, 0x00, 0x80, 0x40, 0x20, 0x10, 0x08, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00, // < 28
     0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, // = 29
     0x00, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00, // > 30
     0x00, 0x70, 0x48, 0x08, 0x08, 0x08, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x30, 0x36, 0x01, 0x00, 0x00, // ? 31
     0xC0, 0x30, 0xC8, 0x28, 0xE8, 0x10, 0xE0, 0x00, 0x07, 0x18, 0x27, 0x24, 0x23, 0x14, 0x0B, 0x00, // @ 32
     0x00, 0x00, 0xC0, 0x38, 0xE0, 0x00, 0x00, 0x00, 0x20, 0x3C, 0x23, 0x02, 0x02, 0x27, 0x38, 0x20, // A 33
     0x08, 0xF8, 0x88, 0x88, 0x88, 0x70, 0x00, 0x00, 0x20, 0x3F, 0x20, 0x20, 0x20, 0x11, 0x0E, 0x00, // B 34
     0xC0, 0x30, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00, 0x07, 0x18, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00, // C 35
     0x08, 0xF8, 0x08, 0x08, 0x08, 0x10, 0xE0, 0x00, 0x20, 0x3F, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x00, // D 36
     0x08, 0xF8, 0x88, 0x88, 0xE8, 0x08, 0x10, 0x00, 0x20, 0x3F, 0x20, 0x20, 0x23, 0x20, 0x18, 0x00, // E 37
     0x08, 0xF8, 0x88, 0x88, 0xE8, 0x08, 0x10, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x03, 0x00, 0x00, 0x00, // F 38
     0xC0, 0x30, 0x08, 0x08, 0x08, 0x38, 0x00, 0x00, 0x07, 0x18, 0x20, 0x20, 0x22, 0x1E, 0x02, 0x00, // G 39
     0x08, 0xF8, 0x08, 0x00, 0x00, 0x08, 0xF8, 0x08, 0x20, 0x3F, 0x21, 0x01, 0x01, 0x21, 0x3F, 0x20, // H 40
     0x00, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x00, 0x00, 0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00, // I 41
     0x00, 0x00, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x00, 0xC0, 0x80, 0x80, 0x80, 0x7F, 0x00, 0x00, 0x00, // J 42
     0x08, 0xF8, 0x88, 0xC0, 0x28, 0x18, 0x08, 0x00, 0x20, 0x3F, 0x20, 0x01, 0x26, 0x38, 0x20, 0x00, // K 43
     0x08, 0xF8, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x3F, 0x20, 0x20, 0x20, 0x20, 0x30, 0x00, // L 44
     0x08, 0xF8, 0xF8, 0x00, 0xF8, 0xF8, 0x08, 0x00, 0x20, 0x3F, 0x00, 0x3F, 0x00, 0x3F, 0x20, 0x00, // M 45
     0x08, 0xF8, 0x30, 0xC0, 0x00, 0x08, 0xF8, 0x08, 0x20, 0x3F, 0x20, 0x00, 0x07, 0x18, 0x3F, 0x00, // N 46
     0xE0, 0x10, 0x08, 0x08, 0x08, 0x10, 0xE0, 0x00, 0x0F, 0x10, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x00, // O 47
     0x08, 0xF8, 0x08, 0x08, 0x08, 0x08, 0xF0, 0x00, 0x20, 0x3F, 0x21, 0x01, 0x01, 0x01, 0x00, 0x00, // P 48
     0xE0, 0x10, 0x08, 0x08, 0x08, 0x10, 0xE0, 0x00, 0x0F, 0x18, 0x24, 0x24, 0x38, 0x50, 0x4F, 0x00, // Q 49
     0x08, 0xF8, 0x88, 0x88, 0x88, 0x88, 0x70, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x03, 0x0C, 0x30, 0x20, // R 50
     0x00, 0x70, 0x88, 0x08, 0x08, 0x08, 0x38, 0x00, 0x00, 0x38, 0x20, 0x21, 0x21, 0x22, 0x1C, 0x00, // S 51
     0x18, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x18, 0x00, 0x00, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x00, 0x00, // T 52
     0x08, 0xF8, 0x08, 0x00, 0x00, 0x08, 0xF8, 0x08, 0x00, 0x1F, 0x20, 0x20, 0x20, 0x20, 0x1F, 0x00, // U 53
     0x08, 0x78, 0x88, 0x00, 0x00, 0xC8, 0x38, 0x08, 0x00, 0x00, 0x07, 0x38, 0x0E, 0x01, 0x00, 0x00, // V 54
     0xF8, 0x08, 0x00, 0xF8, 0x00, 0x08, 0xF8, 0x00, 0x03, 0x3C, 0x07, 0x00, 0x07, 0x3C, 0x03, 0x00, // W 55
     0x08, 0x18, 0x68, 0x80, 0x80, 0x68, 0x18, 0x08, 0x20, 0x30, 0x2C, 0x03, 0x03, 0x2C, 0x30, 0x20, // X 56
     0x08, 0x38, 0xC8, 0x00, 0xC8, 0x38, 0x08, 0x00, 0x00, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x00, 0x00, // Y 57
     0x10, 0x08, 0x08, 0x08, 0xC8, 0x38, 0x08, 0x00, 0x20, 0x38, 0x26, 0x21, 0x20, 0x20, 0x18, 0x00, // Z 58
     0x00, 0x00, 0x00, 0xFE, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x40, 0x40, 0x40, 0x00, // [ 59
     0x00, 0x0C, 0x30, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x38, 0xC0, 0x00, // \ 60
     0x00, 0x02, 0x02, 0x02, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x40, 0x7F, 0x00, 0x00, 0x00, // ] 61
     0x00, 0x00, 0x04, 0x02, 0x02, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ^ 62
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, // _ 63
     0x00, 0x02, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ` 64
     0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x19, 0x24, 0x22, 0x22, 0x22, 0x3F, 0x20, // a 65
     0x08, 0xF8, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x11, 0x20, 0x20, 0x11, 0x0E, 0x00, // b 66
     0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x0E, 0x11, 0x20, 0x20, 0x20, 0x11, 0x00, // c 67
     0x00, 0x00, 0x00, 0x80, 0x80, 0x88, 0xF8, 0x00, 0x00, 0x0E, 0x11, 0x20, 0x20, 0x10, 0x3F, 0x20, // d 68
     0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x1F, 0x22, 0x22, 0x22, 0x22, 0x13, 0x00, // e 69
     0x00, 0x80, 0x80, 0xF0, 0x88, 0x88, 0x88, 0x18, 0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00, // f 70
     0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x6B, 0x94, 0x94, 0x94, 0x93, 0x60, 0x00, // g 71
     0x08, 0xF8, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x20, 0x3F, 0x21, 0x00, 0x00, 0x20, 0x3F, 0x20, // h 72
     0x00, 0x80, 0x98, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00, // i 73
     0x00, 0x00, 0x00, 0x80, 0x98, 0x98, 0x00, 0x00, 0x00, 0xC0, 0x80, 0x80, 0x80, 0x7F, 0x00, 0x00, // j 74
     0x08, 0xF8, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x20, 0x3F, 0x24, 0x02, 0x2D, 0x30, 0x20, 0x00, // k 75
     0x00, 0x08, 0x08, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x3F, 0x20, 0x20, 0x00, 0x00, // l 76
     0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x20, 0x3F, 0x20, 0x00, 0x3F, 0x20, 0x00, 0x3F, // m 77
     0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x20, 0x3F, 0x21, 0x00, 0x00, 0x20, 0x3F, 0x20, // n 78
     0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x1F, 0x20, 0x20, 0x20, 0x20, 0x1F, 0x00, // o 79
     0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xA1, 0x20, 0x20, 0x11, 0x0E, 0x00, // p 80
     0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x0E, 0x11, 0x20, 0x20, 0xA0, 0xFF, 0x80, // q 81
     0x80, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x00, 0x20, 0x20, 0x3F, 0x21, 0x20, 0x00, 0x01, 0x00, // r 82
     0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x33, 0x24, 0x24, 0x24, 0x24, 0x19, 0x00, // s 83
     0x00, 0x80, 0x80, 0xE0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x20, 0x20, 0x00, 0x00, // t 84
     0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x1F, 0x20, 0x20, 0x20, 0x10, 0x3F, 0x20, // u 85
     0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x01, 0x0E, 0x30, 0x08, 0x06, 0x01, 0x00, // v 86
     0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x80, 0x0F, 0x30, 0x0C, 0x03, 0x0C, 0x30, 0x0F, 0x00, // w 87
     0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x20, 0x31, 0x2E, 0x0E, 0x31, 0x20, 0x00, // x 88
     0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x81, 0x8E, 0x70, 0x18, 0x06, 0x01, 0x00, // y 89
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x21, 0x30, 0x2C, 0x22, 0x21, 0x30, 0x00, // z 90
     0x00, 0x00, 0x00, 0x00, 0x80, 0x7C, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x40, 0x40, // { 91
     0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, // | 92
     0x00, 0x02, 0x02, 0x7C, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x3F, 0x00, 0x00, 0x00, 0x00, // } 93
     0x00, 0x06, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ~ 94
 };

unsigned char code temperature_symbol[][16] = {
    0x00, 0x0C, 0x12, 0x12, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 度
    0xC0, 0x30, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00, 0x07, 0x18, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00, // C 
};


void delay(unsigned cnt) {
    while(--cnt);
}

void Ack_I2c(void) {
    SDA = 0;     
    _Nop();    
    SCL = 1;
    _Nop();
    _Nop();  
    SCL = 0;  
    _Nop();    
}

void NoAck_I2c(void) {
    SDA = 1;
    _Nop();      
    SCL = 1;
    _Nop();
    _Nop();  
    SCL = 0;              
    _Nop();    
}

void i2c_start(void) {
    SDA = 1;   
    _Nop();
    SCL = 1;
    _Nop();
    _Nop();    
    SDA = 0;    
    _Nop();
    _Nop();       
    SCL = 0; 
    _Nop();
}
 
void i2c_stop(void) {
  SDA = 0;    
  _Nop();  
  SCL = 1;    
  _Nop();
  _Nop();
  SDA = 1;   
  _Nop();
  _Nop();
}
 
void i2c_write(unsigned char val) {
    unsigned char BitCnt;
    
    for(BitCnt = 0; BitCnt < 8; BitCnt++) {
        if((val << BitCnt) & 0x80) SDA = 1;  
        else  SDA = 0;                
        _Nop();
        SCL = 1;              
        _Nop();
        _Nop();         
        SCL = 0; 
    }
        
    _Nop();
    SDA = 1;           
    _Nop();   
    SCL = 1;
    _Nop();
    _Nop();
    if(SDA == 1) ack = 0;     
    else ack = 1;       
    SCL = 0;
    _Nop();
    _Nop();
}

unsigned char i2c_read() {
    unsigned char retc;
    unsigned char BitCnt;
    
    retc = 0; 
    SDA = 1;
    for(BitCnt = 0; BitCnt < 8; BitCnt++) {
        _Nop();           
        SCL = 0;     
        _Nop();
        _Nop();
        SCL = 1;
        _Nop();
        retc =  retc << 1;
        if(SDA == 1) retc = retc + 1; 
        _Nop(); 
    }
    SCL = 0;    
    _Nop();
    _Nop();

    NoAck_I2c();
    return(retc);

}

void Write_IIC_Command(unsigned char c) {
    i2c_start();
    i2c_write(0x78);
    i2c_write(0x00);
    i2c_write(c);
    i2c_stop();
}
 
void Write_IIC_Data(unsigned char c) {
    i2c_start();
    i2c_write(0x78);
    i2c_write(0x40);
    i2c_write(c);
    i2c_stop();
}

void OLED_WR_Byte(unsigned dat,unsigned cmd) {
	if(cmd) 
		Write_IIC_Data(dat);
	else
		Write_IIC_Command(dat);
}

void OLED_Set_Pos(unsigned char x, unsigned char y) {
	OLED_WR_Byte(0xb0 + y, OLED_CMD);
	OLED_WR_Byte((((x + 2) & 0xf0) >> 4) | 0x10, OLED_CMD);
	OLED_WR_Byte(((x + 2) & 0x0f), OLED_CMD);
}
 
void OLED_Clear(void){
	unsigned char i, n;
	for(i = 0; i < 8; i++) {
		OLED_WR_Byte (0xb0 + i, OLED_CMD);   
		OLED_WR_Byte (0x02, OLED_CMD);     
		OLED_WR_Byte (0x10, OLED_CMD);      
		for(n = 0; n < 128; n++)
            OLED_WR_Byte(0, OLED_DATA);
	} 
}

void OLED_Init(void) {
	OLED_WR_Byte(0xAE, OLED_CMD);//--turn off oled panel
	OLED_WR_Byte(0x02, OLED_CMD);//---set low column address
	OLED_WR_Byte(0x10, OLED_CMD);//---set high column address
	OLED_WR_Byte(0x40, OLED_CMD);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
	OLED_WR_Byte(0x81, OLED_CMD);//--set contrast control register
	OLED_WR_Byte(0xCF, OLED_CMD); // Set SEG Output Current Brightness
	OLED_WR_Byte(0xA1, OLED_CMD);//--Set SEG/Column Mapping     
	OLED_WR_Byte(0xC8, OLED_CMD);//Set COM/Row Scan Direction   
	OLED_WR_Byte(0xA6, OLED_CMD);//--set normal display
	OLED_WR_Byte(0xA8, OLED_CMD);//--set multiplex ratio(1 to 64)
	OLED_WR_Byte(0x3f, OLED_CMD);//--1/64 duty
	OLED_WR_Byte(0xD3, OLED_CMD);//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)
	OLED_WR_Byte(0x00, OLED_CMD);//-not offset
	OLED_WR_Byte(0xd5, OLED_CMD);//--set display clock divide ratio/oscillator frequency
	OLED_WR_Byte(0x80, OLED_CMD);//--set divide ratio, Set Clock as 100 Frames/Sec
	OLED_WR_Byte(0xD9, OLED_CMD);//--set pre-charge period
	OLED_WR_Byte(0xF1, OLED_CMD);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
	OLED_WR_Byte(0xDA, OLED_CMD);//--set com pins hardware configuration
	OLED_WR_Byte(0x12, OLED_CMD);
	OLED_WR_Byte(0xDB, OLED_CMD);//--set vcomh
	OLED_WR_Byte(0x40, OLED_CMD);//Set VCOM Deselect Level
	OLED_WR_Byte(0xA4, OLED_CMD);// Disable Entire Display On (0xa4/0xa5)
	OLED_WR_Byte(0xA6, OLED_CMD);// Disable Inverse Display On (0xa6/a7)
	OLED_WR_Byte(0xAF, OLED_CMD);//--turn on oled panel
	OLED_Clear();
	OLED_Set_Pos(0, 0);
}

void OLED_ShowChar8_16(unsigned char x, unsigned char y, unsigned char chr) {
	unsigned char c = 0, i = 0;
	c = chr - ' ';
	if(x > 128 - 1) {
        x = 0;
        y = y + 2;
    }

	OLED_Set_Pos(x, y * 2);
	for(i = 0; i < 8; i++)
		OLED_WR_Byte(F8x16[c][i], OLED_DATA);
	OLED_Set_Pos(x, y * 2 + 1);
	for(i = 8; i < 16; i++)
		OLED_WR_Byte(F8x16[c][i], OLED_DATA); 
}

/*------------------------------------------------
                   函數聲明
------------------------------------------------*/
void SendStr(unsigned char *s);

/*------------------------------------------------
                    串口初始化
------------------------------------------------*/
void InitUART(void) {
    SCON  = 0x50;              // 模式1，8位UART，允許接收  
    TMOD |= 0x20;              // Timer1，模式2，自動重載
    TH1   = 0xFD;              // 9600波特率，晶振11.0592MHz  
    TR1   = 1;                 // 啟動定時器1                       
    EA    = 1;                 // 開啟總中斷
    // ES = 1;                 // 暫不啟用串口中斷
}

void parse_uart_data(char *raw) {
    char *token;
    
    token = strtok(raw, ",");
    while (token != NULL) { 
        if (strncmp(token, "CITY:", 5) == 0) 
            strcpy(city, token + 5);
        else if (strncmp(token, "ALIAS:", 6) == 0)
            strcpy(alias, token + 6);
        else if (strncmp(token, "TEMP:", 5) == 0)
            strcpy(temp, token + 5);
        else if (strncmp(token, "UTC:", 4) == 0)
            strcpy(utc, token + 4);
        else if (strncmp(token, "TIME:", 5) == 0)
            strcpy(time, token + 5);
        else if (strncmp(token, "HUMIDITY:", 9) == 0)
            strcpy(humidity, token + 9);
        else if (strncmp(token, "WEATHER:", 8) == 0)
            strcpy(weather, token + 8);
        token = strtok(NULL, ",");
    }
}

void DelayUs2x(unsigned char t) {
	while (--t);
}

void DelayMs(unsigned char t) {
	while (--t) {
		// 大致延時1mS
		DelayUs2x(245);
		DelayUs2x(245);
	}
}

void OLED_ShowCenterString8_16(unsigned char row, char *str) {
    unsigned char len = strlen(str);
    unsigned char pixel_width = len * 8;
    unsigned char start_x = (128 - pixel_width) / 2;
    unsigned char j;
    for (j = 0; j < len; j++) {
        OLED_ShowChar8_16(start_x + 8 * j, row, str[j]);
    }
}

void OLED_ShowTemperatureSymbol8_16(unsigned char x, unsigned char y, unsigned char idx) {
	unsigned char i = 0;
	if (x > 128 - 1) {
        x = 0;
        y = y + 2;
    }

	OLED_Set_Pos(x, y * 2);
	for(i = 0; i < 8; i++)
		OLED_WR_Byte(temperature_symbol[idx][i], OLED_DATA);
	OLED_Set_Pos(x, y * 2 + 1);
	for(i = 8; i < 16; i++)
		OLED_WR_Byte(temperature_symbol[idx][i], OLED_DATA); 
}

void main(void) {
    unsigned char key = 0, j = 0, i = 0;   
    unsigned char len, pixel_width, start_x; // 這串其實沒用到，因為我把它移到 OLED_ShowCenterString8_16 函式了
    char date[11], time_only[9], utc_disp[5], msg[30];
    bit done_flag = 0;
    InitUART();
    ES = 1;                    // 開啟串口中斷
    OLED_Init();

    while (1) {
        if (KeyPort != 0xff || done_flag) {
			DelayMs(10);
			if (KeyPort != 0xff || done_flag) {
				key = KeyPort;
                if (done_flag) { // 預設顯示時間
                    done_flag = 0;
                    key = 0xfe; 
                } 
				while (KeyPort != 0xff);
				switch (key) {
				case 0xfe: // 按鈕 1 顯示時間
                    OLED_Clear(); 
                    SendStr("UTC: "); SendStr(utc); 
                    SendStr("Time: "); SendStr(time);

                    sprintf(line1, "%s(%s)", city, alias);  
                    OLED_ShowCenterString8_16(0, line1);

                    strcpy(line2, "Current Time");
                    OLED_ShowCenterString8_16(1, line2);

                    if (utc[0] == '-') {
                        sprintf(utc_disp, "-%c", utc[1]);
                        if (utc[2] >= '0' && utc[2] <= '9')
                            sprintf(utc_disp, "-%c%c", utc[1], utc[2]);
                    } else {
                        sprintf(utc_disp, "+%c", utc[0]);
                        if (utc[1] >= '0' && utc[1] <= '9')
                            sprintf(utc_disp, "+%c%c", utc[0], utc[1]);
                    }

                    strncpy(date, time, 10);
                    date[10] = '\0';

                    strncpy(time_only, time + 11, 8);
                    time_only[8] = '\0';

                    sprintf(line3, "%s %s", utc_disp, date);
                    OLED_ShowCenterString8_16(2, line3);

                    strcpy(line4, time_only);
                    OLED_ShowCenterString8_16(3, line4);
                    break;
				case 0xfd: // 按鈕 2
                    SendStr("key 2 (unused)"); 
					break;
				case 0xfb: // 按鈕 3 顯示溫度
                    OLED_Clear();
                    SendStr("Temperature: "); SendStr(temp); 

                    sprintf(line1, "%s(%s)", city, alias);  
                    OLED_ShowCenterString8_16(0, line1);
                    strcpy(line2, "Current Temp");
                    OLED_ShowCenterString8_16(1, line2);
                    sprintf(line3, "%s", temp);  
                    len = strlen(line3);
                    pixel_width = len * 8 + 16;  // 加16像素給符號
                    start_x = (128 - pixel_width) / 2;
                    for (j = 0; j < len; j++) {
                        OLED_ShowChar8_16(start_x + 8 * j, 2, line3[j]);
                    }
                    OLED_ShowTemperatureSymbol8_16(start_x + 8 * len, 2, 0);      // 度
                    OLED_ShowTemperatureSymbol8_16(start_x + 8 * len + 8, 2, 1);  // C
					break;
				case 0xf7: // 按鈕 4
					SendStr("key 4 (unused)");  
					break;
				case 0xef: // 按鈕 5 顯示濕度
					OLED_Clear();
                    SendStr("Humidity: "); SendStr(humidity); 

                    sprintf(line1, "%s(%s)", city, alias);  
                    OLED_ShowCenterString8_16(0, line1);

                    strcpy(line2, "Current Humidity");
                    OLED_ShowCenterString8_16(1, line2);

                    sprintf(line3, "%s %%", humidity);  
                    OLED_ShowCenterString8_16(2, line3);
					break;
				case 0xdf: // 按鈕 6
					SendStr("key 6 (unused)");
					break;
				case 0xbf: // 按鈕 7 顯示天氣
                    OLED_Clear();
                    SendStr("Weather: "); SendStr(weather); 

                    sprintf(line1, "%s(%s)", city, alias);  
                    OLED_ShowCenterString8_16(0, line1);

                    strcpy(line2, "Current Weather");
                    OLED_ShowCenterString8_16(1, line2);

                    sprintf(line3, "%s", weather);  
                    OLED_ShowCenterString8_16(2, line3);
					break;
				case 0x7f: // 按鈕 8 refresh 功能
					sprintf(msg, "Refresh,%s,%s", city, alias);
                    SendStr(msg);
					break;
				default:
					break;
				}
			}
		}

        if (loading_signal) {
            loading_signal = 0;
            OLED_Clear();
            OLED_ShowCenterString8_16(0, "Loading...");
        }

        if (ready) {
            ready = 0;

            if (strcmp(buffer, "loading") == 0) {
                loading_signal = 1;
                continue;
            }

            memset(city, 0, sizeof(city));
            memset(alias, 0, sizeof(alias));
            memset(temp, 0, sizeof(temp));
            memset(utc, 0, sizeof(utc));
            memset(time, 0, sizeof(time));
            memset(humidity, 0, sizeof(humidity));
            memset(weather, 0, sizeof(weather));
            memset(line1, 0, sizeof(line1));
            memset(line2, 0, sizeof(line2));
            memset(line3, 0, sizeof(line3));
            memset(line4, 0, sizeof(line4));
            memset(msg, 0, sizeof(msg));

            OLED_Clear();
            SendStr(buffer);
            parse_uart_data(buffer);
            done_flag = 1;
            // SendStr("City: "); SendStr(city); 
            // SendStr("Alias: "); SendStr(alias); 
        }
    }
}

/*------------------------------------------------
                    發送一個字節
------------------------------------------------*/
void SendByte(unsigned char dat) {
    SBUF = dat;
    while (!TI);
    TI = 0;
}

/*------------------------------------------------
                    發送一個字符串
------------------------------------------------*/
void SendStr(unsigned char *s) {
    while (*s != '\0') {
        SendByte(*s);
        s++;
    }
    // SendByte(0x0d);
    // SendByte(0x0a);
}

/*------------------------------------------------
                     串口中斷程序
------------------------------------------------*/
void UART_SER(void) interrupt 4 {
    char content = SBUF;
    if (RI) {
        RI = 0;
        
        content = SBUF;            
        if (content == '\n' || index >= BUF_SIZE - 1) {
            buffer[index] = '\0';
            ready = 1;
            index = 0;
        } else {
            buffer[index++] = content;
        }
    }
}
